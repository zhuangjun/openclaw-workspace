#!/usr/bin/env python3
"""
DCF Valuation Tool - Discounted Cash Flow Model
DCF ä¼°å€¼æ¨¡å‹å·¥å…· - åŸºäºè‡ªç”±ç°é‡‘æµçš„ç»å¯¹ä¼°å€¼æ–¹æ³•

Usage: dcf-valuation [options]
       dcf-valuation --interactive
"""

import sys
import argparse
import json
from dataclasses import dataclass
from typing import List, Tuple


@dataclass
class DCFInputs:
    """DCFæ¨¡å‹è¾“å…¥å‚æ•°"""
    current_fcf: float  # å½“å‰å¹´åº¦è‡ªç”±ç°é‡‘æµ (ç™¾ä¸‡ç¾å…ƒ)
    growth_rate_5y: float  # å‰5å¹´å¢é•¿ç‡
    growth_rate_terminal: float  # æ°¸ç»­å¢é•¿ç‡
    discount_rate: float  # æŠ˜ç°ç‡ (WACC)
    shares_outstanding: float  # æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡)
    net_debt: float = 0  # å‡€å€ºåŠ¡ (ç™¾ä¸‡ç¾å…ƒï¼Œæ­£æ•°è¡¨ç¤ºå‡€è´Ÿå€º)
    projection_years: int = 5  # é¢„æµ‹æœŸå¹´æ•°


class DCFValuation:
    """DCFä¼°å€¼æ¨¡å‹å®ç°"""
    
    def __init__(self, inputs: DCFInputs):
        self.inputs = inputs
    
    def calculate_fcf_projections(self) -> List[Tuple[int, float]]:
        """è®¡ç®—æœªæ¥è‡ªç”±ç°é‡‘æµé¢„æµ‹"""
        projections = []
        fcf = self.inputs.current_fcf
        
        for year in range(1, self.inputs.projection_years + 1):
            fcf = fcf * (1 + self.inputs.growth_rate_5y)
            projections.append((year, fcf))
        
        return projections
    
    def calculate_terminal_value(self, final_fcf: float) -> float:
        """è®¡ç®—ç»ˆå€¼ (Gordon Growth Model)"""
        # TV = FCF_n * (1 + g) / (r - g)
        terminal_fcf = final_fcf * (1 + self.inputs.growth_rate_terminal)
        terminal_value = terminal_fcf / (self.inputs.discount_rate - self.inputs.growth_rate_terminal)
        return terminal_value
    
    def calculate_present_value(self, cash_flows: List[Tuple[int, float]], terminal_value: float) -> dict:
        """è®¡ç®—ç°å€¼"""
        pv_cash_flows = []
        
        for year, fcf in cash_flows:
            pv = fcf / ((1 + self.inputs.discount_rate) ** year)
            pv_cash_flows.append({
                'year': year,
                'fcf': fcf,
                'pv': pv
            })
        
        # ç»ˆå€¼ç°å€¼
        pv_terminal = terminal_value / ((1 + self.inputs.discount_rate) ** self.inputs.projection_years)
        
        # ä¼ä¸šä»·å€¼
        enterprise_value = sum(cf['pv'] for cf in pv_cash_flows) + pv_terminal
        
        return {
            'pv_cash_flows': pv_cash_flows,
            'pv_terminal': pv_terminal,
            'enterprise_value': enterprise_value
        }
    
    def calculate_equity_value(self, enterprise_value: float) -> dict:
        """è®¡ç®—è‚¡æƒä»·å€¼"""
        equity_value = enterprise_value - self.inputs.net_debt
        value_per_share = equity_value / self.inputs.shares_outstanding
        
        return {
            'enterprise_value': enterprise_value,
            'net_debt': self.inputs.net_debt,
            'equity_value': equity_value,
            'shares_outstanding': self.inputs.shares_outstanding,
            'value_per_share': value_per_share
        }
    
    def sensitivity_analysis(self) -> dict:
        """æ•æ„Ÿæ€§åˆ†æ - ä¸åŒWACCå’Œå¢é•¿ç‡ä¸‹çš„ä¼°å€¼"""
        # WACCå˜åŒ–èŒƒå›´
        wacc_range = [
            self.inputs.discount_rate - 0.02,
            self.inputs.discount_rate - 0.01,
            self.inputs.discount_rate,
            self.inputs.discount_rate + 0.01,
            self.inputs.discount_rate + 0.02
        ]
        
        # æ°¸ç»­å¢é•¿ç‡å˜åŒ–èŒƒå›´
        growth_range = [
            max(0.01, self.inputs.growth_rate_terminal - 0.01),
            self.inputs.growth_rate_terminal,
            self.inputs.growth_rate_terminal + 0.01
        ]
        
        sensitivity_matrix = []
        
        for g in growth_range:
            row = []
            for wacc in wacc_range:
                if wacc > g:  # ç¡®ä¿ wacc > g
                    temp_inputs = DCFInputs(
                        current_fcf=self.inputs.current_fcf,
                        growth_rate_5y=self.inputs.growth_rate_5y,
                        growth_rate_terminal=g,
                        discount_rate=wacc,
                        shares_outstanding=self.inputs.shares_outstanding,
                        net_debt=self.inputs.net_debt,
                        projection_years=self.inputs.projection_years
                    )
                    temp_dcf = DCFValuation(temp_inputs)
                    projections = temp_dcf.calculate_fcf_projections()
                    terminal = temp_dcf.calculate_terminal_value(projections[-1][1])
                    pv_result = temp_dcf.calculate_present_value(projections, terminal)
                    equity = temp_dcf.calculate_equity_value(pv_result['enterprise_value'])
                    row.append(equity['value_per_share'])
                else:
                    row.append(None)
            sensitivity_matrix.append({
                'growth_rate': f"{g*100:.1f}%",
                'values': row
            })
        
        return {
            'wacc_range': [f"{w*100:.1f}%" for w in wacc_range],
            'matrix': sensitivity_matrix
        }
    
    def run_valuation(self) -> dict:
        """æ‰§è¡Œå®Œæ•´ä¼°å€¼æµç¨‹"""
        # 1. é¢„æµ‹è‡ªç”±ç°é‡‘æµ
        projections = self.calculate_fcf_projections()
        
        # 2. è®¡ç®—ç»ˆå€¼
        terminal_value = self.calculate_terminal_value(projections[-1][1])
        
        # 3. è®¡ç®—ç°å€¼
        pv_result = self.calculate_present_value(projections, terminal_value)
        
        # 4. è®¡ç®—è‚¡æƒä»·å€¼
        equity_result = self.calculate_equity_value(pv_result['enterprise_value'])
        
        # 5. æ•æ„Ÿæ€§åˆ†æ
        sensitivity = self.sensitivity_analysis()
        
        return {
            'inputs': {
                'current_fcf': self.inputs.current_fcf,
                'growth_rate_5y': self.inputs.growth_rate_5y,
                'growth_rate_terminal': self.inputs.growth_rate_terminal,
                'discount_rate': self.inputs.discount_rate,
                'shares_outstanding': self.inputs.shares_outstanding,
                'net_debt': self.inputs.net_debt
            },
            'projections': [
                {'year': p[0], 'fcf': p[1], 'pv': p[1] / ((1 + self.inputs.discount_rate) ** p[0])}
                for p in projections
            ],
            'terminal_value': terminal_value,
            'pv_terminal': pv_result['pv_terminal'],
            'enterprise_value': pv_result['enterprise_value'],
            'equity_value': equity_result['equity_value'],
            'value_per_share': equity_result['value_per_share'],
            'sensitivity_analysis': sensitivity
        }


def format_currency(value: float, decimals: int = 2) -> str:
    """æ ¼å¼åŒ–è´§å¸æ˜¾ç¤º"""
    if abs(value) >= 1e12:
        return f"${value/1e12:.{decimals}f}T"
    elif abs(value) >= 1e9:
        return f"${value/1e9:.{decimals}f}B"
    elif abs(value) >= 1e6:
        return f"${value/1e6:.{decimals}f}M"
    else:
        return f"${value:,.{decimals}f}"


def print_valuation_report(result: dict, current_price: float = None):
    """æ‰“å°ä¼°å€¼æŠ¥å‘Š"""
    inputs = result['inputs']
    
    print("=" * 60)
    print("ğŸ“Š DCF ä¼°å€¼åˆ†ææŠ¥å‘Š")
    print("=" * 60)
    
    # è¾“å…¥å‚æ•°
    print("\nã€è¾“å…¥å‡è®¾ã€‘")
    print(f"  å½“å‰è‡ªç”±ç°é‡‘æµ: {format_currency(inputs['current_fcf'] * 1e6)}")
    print(f"  å‰5å¹´å¢é•¿ç‡: {inputs['growth_rate_5y']*100:.1f}%")
    print(f"  æ°¸ç»­å¢é•¿ç‡: {inputs['growth_rate_terminal']*100:.1f}%")
    print(f"  æŠ˜ç°ç‡ (WACC): {inputs['discount_rate']*100:.1f}%")
    print(f"  æ€»è‚¡æœ¬: {inputs['shares_outstanding']:.2f} ç™¾ä¸‡è‚¡")
    print(f"  å‡€å€ºåŠ¡: {format_currency(inputs['net_debt'] * 1e6)}")
    
    # è‡ªç”±ç°é‡‘æµé¢„æµ‹
    print("\nã€è‡ªç”±ç°é‡‘æµé¢„æµ‹ã€‘")
    print("-" * 50)
    print(f"{'å¹´ä»½':<10}{'FCF':<20}{'ç°å€¼':<20}")
    print("-" * 50)
    for p in result['projections']:
        print(f"Year {p['year']:<5}{format_currency(p['fcf']*1e6):<20}{format_currency(p['pv']*1e6):<20}")
    print("-" * 50)
    print(f"{'ç»ˆå€¼':<10}{format_currency(result['terminal_value']*1e6):<20}{format_currency(result['pv_terminal']*1e6):<20}")
    
    # ä¼°å€¼ç»“æœ
    print("\nã€ä¼°å€¼ç»“æœã€‘")
    print(f"  ä¼ä¸šä»·å€¼ (EV): {format_currency(result['enterprise_value']*1e6)}")
    print(f"  è‚¡æƒä»·å€¼: {format_currency(result['equity_value']*1e6)}")
    print(f"  æ¯è‚¡å†…åœ¨ä»·å€¼: ${result['value_per_share']:.2f}")
    
    if current_price:
        upside = (result['value_per_share'] - current_price) / current_price * 100
        print(f"  å½“å‰ä»·æ ¼: ${current_price:.2f}")
        print(f"  ä¸Šæ¶¨ç©ºé—´: {upside:+.1f}%")
        
        if upside > 20:
            print(f"  ğŸ“ˆ ä¼°å€¼ç»“è®º: æ˜¾è‘—ä½ä¼°")
        elif upside > 5:
            print(f"  ğŸ“Š ä¼°å€¼ç»“è®º: ç•¥å¾®ä½ä¼°")
        elif upside > -5:
            print(f"  â– ä¼°å€¼ç»“è®º: åˆç†ä¼°å€¼")
        else:
            print(f"  ğŸ“‰ ä¼°å€¼ç»“è®º: é«˜ä¼°")
    
    # æ•æ„Ÿæ€§åˆ†æ
    print("\nã€æ•æ„Ÿæ€§åˆ†æ - æ¯è‚¡ä»·å€¼ (WACC vs æ°¸ç»­å¢é•¿ç‡)ã€‘")
    sens = result['sensitivity_analysis']
    wacc_header = "  ".join([f"{w:<12}" for w in sens['wacc_range']])
    print(f"{'G\\WACC':<10}{wacc_header}")
    print("-" * 70)
    for row in sens['matrix']:
        values_str = "  ".join([f"${v:<11.2f}" if v else f"{'N/A':<12}" for v in row['values']])
        print(f"{row['growth_rate']:<10}{values_str}")
    
    print("\n" + "=" * 60)


def interactive_mode():
    """äº¤äº’æ¨¡å¼ - å¼•å¯¼ç”¨æˆ·è¾“å…¥å‚æ•°"""
    print("\nğŸ§® DCF ä¼°å€¼è®¡ç®—å™¨ (äº¤äº’æ¨¡å¼)")
    print("=" * 50)
    print("æç¤º: æŒ‰Enterä½¿ç”¨é»˜è®¤å€¼\n")
    
    try:
        # è·å–è¾“å…¥
        fcf = float(input("å½“å‰å¹´åº¦è‡ªç”±ç°é‡‘æµ (ç™¾ä¸‡ç¾å…ƒ) [100]: ") or "100")
        growth_5y = float(input("å‰5å¹´å¢é•¿ç‡ (%) [15]: ") or "15") / 100
        growth_terminal = float(input("æ°¸ç»­å¢é•¿ç‡ (%) [3]: ") or "3") / 100
        wacc = float(input("æŠ˜ç°ç‡/WACC (%) [10]: ") or "10") / 100
        shares = float(input("æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡) [1000]: ") or "1000")
        net_debt = float(input("å‡€å€ºåŠ¡ (ç™¾ä¸‡ç¾å…ƒï¼Œè´Ÿå€º>èµ„äº§ä¸ºæ­£) [0]: ") or "0")
        
        current_price_input = input("å½“å‰è‚¡ä»· (å¯é€‰ï¼Œç”¨äºè®¡ç®—ä¸Šæ¶¨ç©ºé—´) [å›è½¦è·³è¿‡]: ").strip()
        current_price = float(current_price_input) if current_price_input else None
        
        # åˆ›å»ºè¾“å…¥å¯¹è±¡
        inputs = DCFInputs(
            current_fcf=fcf,
            growth_rate_5y=growth_5y,
            growth_rate_terminal=growth_terminal,
            discount_rate=wacc,
            shares_outstanding=shares,
            net_debt=net_debt
        )
        
        # æ‰§è¡Œä¼°å€¼
        dcf = DCFValuation(inputs)
        result = dcf.run_valuation()
        
        # æ‰“å°æŠ¥å‘Š
        print_valuation_report(result, current_price)
        
        # ä¿å­˜é€‰é¡¹
        save = input("\næ˜¯å¦ä¿å­˜JSONæ ¼å¼ç»“æœ? (y/n) [n]: ").strip().lower()
        if save == 'y':
            filename = input("æ–‡ä»¶å [dcf_result.json]: ").strip() or "dcf_result.json"
            with open(filename, 'w') as f:
                json.dump(result, f, indent=2)
            print(f"ç»“æœå·²ä¿å­˜åˆ°: {filename}")
        
    except ValueError as e:
        print(f"è¾“å…¥é”™è¯¯: {e}")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\nå·²å–æ¶ˆ")
        sys.exit(0)


def main():
    parser = argparse.ArgumentParser(
        description='DCF ä¼°å€¼æ¨¡å‹å·¥å…· - åŸºäºè‡ªç”±ç°é‡‘æµçš„ç»å¯¹ä¼°å€¼æ–¹æ³•',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  dcf-valuation --interactive              # äº¤äº’æ¨¡å¼
  dcf-valuation --json '{"current_fcf":100,...}'  # JSONè¾“å…¥
        """
    )
    
    parser.add_argument('--interactive', '-i', action='store_true', 
                       help='äº¤äº’æ¨¡å¼ï¼Œå¼•å¯¼è¾“å…¥å‚æ•°')
    parser.add_argument('--json', '-j', type=str,
                       help='JSONæ ¼å¼è¾“å…¥å‚æ•°')
    parser.add_argument('--fcf', type=float, default=100,
                       help='å½“å‰è‡ªç”±ç°é‡‘æµ (ç™¾ä¸‡ç¾å…ƒ) [é»˜è®¤: 100]')
    parser.add_argument('--growth-5y', type=float, default=0.15,
                       help='å‰5å¹´å¢é•¿ç‡ [é»˜è®¤: 0.15]')
    parser.add_argument('--growth-terminal', type=float, default=0.03,
                       help='æ°¸ç»­å¢é•¿ç‡ [é»˜è®¤: 0.03]')
    parser.add_argument('--wacc', type=float, default=0.10,
                       help='æŠ˜ç°ç‡/WACC [é»˜è®¤: 0.10]')
    parser.add_argument('--shares', type=float, default=1000,
                       help='æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡) [é»˜è®¤: 1000]')
    parser.add_argument('--net-debt', type=float, default=0,
                       help='å‡€å€ºåŠ¡ (ç™¾ä¸‡ç¾å…ƒ) [é»˜è®¤: 0]')
    parser.add_argument('--current-price', type=float,
                       help='å½“å‰è‚¡ä»· (ç”¨äºè®¡ç®—ä¸Šæ¶¨ç©ºé—´)')
    parser.add_argument('--save', '-s', type=str,
                       help='ä¿å­˜ç»“æœåˆ°JSONæ–‡ä»¶')
    
    args = parser.parse_args()
    
    if args.interactive:
        interactive_mode()
        return
    
    # ä»JSONæˆ–å‘½ä»¤è¡Œå‚æ•°åˆ›å»ºè¾“å…¥
    if args.json:
        data = json.loads(args.json)
        inputs = DCFInputs(**data)
    else:
        inputs = DCFInputs(
            current_fcf=args.fcf,
            growth_rate_5y=args.growth_5y,
            growth_rate_terminal=args.growth_terminal,
            discount_rate=args.wacc,
            shares_outstanding=args.shares,
            net_debt=args.net_debt
        )
    
    # æ‰§è¡Œä¼°å€¼
    dcf = DCFValuation(inputs)
    result = dcf.run_valuation()
    
    # æ‰“å°æŠ¥å‘Š
    print_valuation_report(result, args.current_price)
    
    # ä¿å­˜ç»“æœ
    if args.save:
        with open(args.save, 'w') as f:
            json.dump(result, f, indent=2)
        print(f"\nç»“æœå·²ä¿å­˜åˆ°: {args.save}")


if __name__ == '__main__':
    main()
