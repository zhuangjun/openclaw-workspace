#!/usr/bin/env python3
"""
Financial Modeling Prep è´¢æŠ¥åˆ†æå·¥å…·
æ”¯æŒè·å–åˆ©æ¶¦è¡¨ã€èµ„äº§è´Ÿå€ºè¡¨ã€ç°é‡‘æµé‡è¡¨åŠå…³é”®è´¢åŠ¡æŒ‡æ ‡
"""
import requests
import json
import sys
import os
from datetime import datetime

# APIé…ç½®
FMP_BASE_URL = "https://financialmodelingprep.com/api/v3"
API_KEY = os.environ.get("FMP_API_KEY", "demo")  # ä¼˜å…ˆä»ç¯å¢ƒå˜é‡è¯»å–

class FinancialAnalyzer:
    """è´¢æŠ¥åˆ†æå™¨"""
    
    def __init__(self, api_key=None):
        self.api_key = api_key or API_KEY
        self.base_url = FMP_BASE_URL
    
    def _make_request(self, endpoint, params=None):
        """å‘é€APIè¯·æ±‚"""
        url = f"{self.base_url}/{endpoint}"
        params = params or {}
        params["apikey"] = self.api_key
        
        try:
            response = requests.get(url, params=params, timeout=30)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"âŒ è¯·æ±‚å¤±è´¥: {e}")
            return None
    
    def get_income_statement(self, symbol, period="annual", limit=5):
        """è·å–åˆ©æ¶¦è¡¨"""
        endpoint = f"income-statement/{symbol}"
        params = {"period": period, "limit": limit}
        return self._make_request(endpoint, params)
    
    def get_balance_sheet(self, symbol, period="annual", limit=5):
        """è·å–èµ„äº§è´Ÿå€ºè¡¨"""
        endpoint = f"balance-sheet-statement/{symbol}"
        params = {"period": period, "limit": limit}
        return self._make_request(endpoint, params)
    
    def get_cash_flow(self, symbol, period="annual", limit=5):
        """è·å–ç°é‡‘æµé‡è¡¨"""
        endpoint = f"cash-flow-statement/{symbol}"
        params = {"period": period, "limit": limit}
        return self._make_request(endpoint, params)
    
    def get_financial_ratios(self, symbol, limit=5):
        """è·å–è´¢åŠ¡æ¯”ç‡"""
        endpoint = f"ratios/{symbol}"
        params = {"limit": limit}
        return self._make_request(endpoint, params)
    
    def get_key_metrics(self, symbol, limit=5):
        """è·å–å…³é”®æŒ‡æ ‡"""
        endpoint = f"key-metrics/{symbol}"
        params = {"limit": limit}
        return self._make_request(endpoint, params)
    
    def get_company_profile(self, symbol):
        """è·å–å…¬å¸èµ„æ–™"""
        endpoint = f"profile/{symbol}"
        return self._make_request(endpoint)
    
    def format_currency(self, value, unit="auto"):
        """æ ¼å¼åŒ–è´§å¸"""
        if value is None:
            return "N/A"
        
        if unit == "auto":
            if abs(value) >= 1e12:
                return f"${value/1e12:.2f}T"
            elif abs(value) >= 1e9:
                return f"${value/1e9:.2f}B"
            elif abs(value) >= 1e6:
                return f"${value/1e6:.2f}M"
            else:
                return f"${value:,.0f}"
        elif unit == "B":
            return f"${value/1e9:.2f}B"
        elif unit == "M":
            return f"${value/1e6:.2f}M"
        return f"${value:,.0f}"
    
    def analyze_financial_health(self, symbol):
        """ç»¼åˆåˆ†æè´¢åŠ¡å¥åº·çŠ¶å†µ"""
        print(f"\n{'='*70}")
        print(f"ğŸ“Š {symbol} è´¢æŠ¥åˆ†ææŠ¥å‘Š")
        print(f"{'='*70}")
        
        # è·å–å…¬å¸èµ„æ–™
        profile = self.get_company_profile(symbol)
        if profile and len(profile) > 0:
            p = profile[0]
            print(f"\nã€å…¬å¸ä¿¡æ¯ã€‘")
            print(f"  åç§°: {p.get('companyName', 'N/A')}")
            print(f"  è¡Œä¸š: {p.get('industry', 'N/A')}")
            print(f"  æ¿å—: {p.get('sector', 'N/A')}")
            print(f"  å¸‚å€¼: {self.format_currency(p.get('mktCap'))}")
            print(f"  å‘˜å·¥: {p.get('fullTimeEmployees', 'N/A'):,}" if p.get('fullTimeEmployees') else "  å‘˜å·¥: N/A")
            print(f"  å®˜ç½‘: {p.get('website', 'N/A')}")
        
        # è·å–åˆ©æ¶¦è¡¨
        income = self.get_income_statement(symbol, limit=4)
        if income and len(income) > 0:
            print(f"\nã€åˆ©æ¶¦è¡¨åˆ†æã€‘")
            print(f"{'å¹´ä»½':<10} {'è¥æ”¶':<15} {'æ¯›åˆ©':<15} {'è¥ä¸šåˆ©æ¶¦':<15} {'å‡€åˆ©æ¶¦':<15}")
            print(f"{'-'*70}")
            
            for item in income[:4]:
                date = item.get('date', 'N/A')[:4]
                revenue = self.format_currency(item.get('revenue'))
                gross_profit = self.format_currency(item.get('grossProfit'))
                operating_income = self.format_currency(item.get('operatingIncome'))
                net_income = self.format_currency(item.get('netIncome'))
                print(f"{date:<10} {revenue:<15} {gross_profit:<15} {operating_income:<15} {net_income:<15}")
            
            # è®¡ç®—åŒæ¯”å¢é•¿
            if len(income) >= 2:
                latest = income[0]
                previous = income[1]
                revenue_growth = ((latest.get('revenue', 0) - previous.get('revenue', 0)) / previous.get('revenue', 1)) * 100
                net_income_growth = ((latest.get('netIncome', 0) - previous.get('netIncome', 0)) / previous.get('netIncome', 1)) * 100
                print(f"\n  è¥æ”¶åŒæ¯”: {'+' if revenue_growth >= 0 else ''}{revenue_growth:.1f}%")
                print(f"  å‡€åˆ©åŒæ¯”: {'+' if net_income_growth >= 0 else ''}{net_income_growth:.1f}%")
        
        # è·å–èµ„äº§è´Ÿå€ºè¡¨
        balance = self.get_balance_sheet(symbol, limit=2)
        if balance and len(balance) > 0:
            print(f"\nã€èµ„äº§è´Ÿå€ºè¡¨å…³é”®æŒ‡æ ‡ã€‘")
            latest = balance[0]
            print(f"  æ€»èµ„äº§: {self.format_currency(latest.get('totalAssets'))}")
            print(f"  æ€»è´Ÿå€º: {self.format_currency(latest.get('totalLiabilities'))}")
            print(f"  è‚¡ä¸œæƒç›Š: {self.format_currency(latest.get('totalStockholdersEquity'))}")
            
            # è®¡ç®—èµ„äº§è´Ÿå€ºç‡
            total_assets = latest.get('totalAssets', 0)
            total_liabilities = latest.get('totalLiabilities', 0)
            if total_assets > 0:
                debt_ratio = (total_liabilities / total_assets) * 100
                print(f"  èµ„äº§è´Ÿå€ºç‡: {debt_ratio:.1f}%")
            
            # æµåŠ¨æ¯”ç‡
            current_assets = latest.get('totalCurrentAssets', 0)
            current_liabilities = latest.get('totalCurrentLiabilities', 0)
            if current_liabilities > 0:
                current_ratio = current_assets / current_liabilities
                print(f"  æµåŠ¨æ¯”ç‡: {current_ratio:.2f}")
        
        # è·å–ç°é‡‘æµé‡è¡¨
        cashflow = self.get_cash_flow(symbol, limit=2)
        if cashflow and len(cashflow) > 0:
            print(f"\nã€ç°é‡‘æµé‡è¡¨ã€‘")
            latest = cashflow[0]
            print(f"  ç»è¥æ´»åŠ¨ç°é‡‘æµ: {self.format_currency(latest.get('operatingCashFlow'))}")
            print(f"  æŠ•èµ„æ´»åŠ¨ç°é‡‘æµ: {self.format_currency(latest.get('investingCashFlow'))}")
            print(f"  ç­¹èµ„æ´»åŠ¨ç°é‡‘æµ: {self.format_currency(latest.get('financingCashFlow'))}")
            print(f"  è‡ªç”±ç°é‡‘æµ: {self.format_currency(latest.get('freeCashFlow'))}")
            
            # è®¡ç®—ç°é‡‘æµè´¨é‡
            operating_cf = latest.get('operatingCashFlow', 0)
            net_income = income[0].get('netIncome', 1) if income else 1
            if net_income > 0:
                cf_quality = operating_cf / net_income
                print(f"  ç°é‡‘æµ/å‡€åˆ©æ¶¦æ¯”ç‡: {cf_quality:.2f}")
        
        # è·å–è´¢åŠ¡æ¯”ç‡
        ratios = self.get_financial_ratios(symbol, limit=2)
        if ratios and len(ratios) > 0:
            print(f"\nã€è´¢åŠ¡æ¯”ç‡ã€‘")
            latest = ratios[0]
            print(f"  ROE (å‡€èµ„äº§æ”¶ç›Šç‡): {latest.get('returnOnEquity', 0)*100:.1f}%")
            print(f"  ROA (æ€»èµ„äº§æ”¶ç›Šç‡): {latest.get('returnOnAssets', 0)*100:.1f}%")
            print(f"  æ¯›åˆ©ç‡: {latest.get('grossProfitMargin', 0)*100:.1f}%")
            print(f"  è¥ä¸šåˆ©æ¶¦ç‡: {latest.get('operatingProfitMargin', 0)*100:.1f}%")
            print(f"  å‡€åˆ©æ¶¦ç‡: {latest.get('netProfitMargin', 0)*100:.1f}%")
        
        # è·å–å…³é”®æŒ‡æ ‡
        metrics = self.get_key_metrics(symbol, limit=2)
        if metrics and len(metrics) > 0:
            print(f"\nã€ä¼°å€¼æŒ‡æ ‡ã€‘")
            latest = metrics[0]
            print(f"  P/E (å¸‚ç›ˆç‡): {latest.get('peRatio', 'N/A')}")
            print(f"  P/B (å¸‚å‡€ç‡): {latest.get('pbRatio', 'N/A')}")
            print(f"  EV/EBITDA: {latest.get('enterpriseValueOverEBITDA', 'N/A')}")
            print(f"  è‚¡æ¯ç‡: {latest.get('dividendYield', 0)*100:.2f}%" if latest.get('dividendYield') else "  è‚¡æ¯ç‡: N/A")
        
        print(f"\n{'='*70}")
        print(f"âœ… {symbol} åˆ†æå®Œæˆ | æ•°æ®æ¥æº: Financial Modeling Prep")
        print(f"{'='*70}\n")


def main():
    """ä¸»å‡½æ•°"""
    import argparse
    
    parser = argparse.ArgumentParser(description='è´¢æŠ¥åˆ†æå·¥å…· - Financial Modeling Prep')
    parser.add_argument('symbol', help='è‚¡ç¥¨ä»£ç  (å¦‚: AAPL, MSFT)')
    parser.add_argument('--api-key', help='FMP API Key (é»˜è®¤ä»ç¯å¢ƒå˜é‡FMP_API_KEYè¯»å–)')
    parser.add_argument('--period', choices=['annual', 'quarter'], default='annual', help='æŠ¥å‘Šå‘¨æœŸ')
    parser.add_argument('--json', action='store_true', help='ä»¥JSONæ ¼å¼è¾“å‡º')
    parser.add_argument('--save', help='ä¿å­˜ç»“æœåˆ°æ–‡ä»¶')
    
    args = parser.parse_args()
    
    # æ£€æŸ¥API Key
    api_key = args.api_key or os.environ.get("FMP_API_KEY")
    if not api_key or api_key == "demo":
        print("âš ï¸  è­¦å‘Š: ä½¿ç”¨demo API Keyï¼Œæ•°æ®å¯èƒ½å—é™")
        print("  è¯·è®¾ç½®ç¯å¢ƒå˜é‡ FMP_API_KEY æˆ–ä¼ å…¥ --api-key å‚æ•°")
        print("  è·å–å…è´¹API Key: https://financialmodelingprep.com/developer/docs")
        print()
    
    # åˆ›å»ºåˆ†æå™¨
    analyzer = FinancialAnalyzer(api_key)
    
    if args.json:
        # JSONè¾“å‡ºæ¨¡å¼
        result = {
            "symbol": args.symbol,
            "timestamp": datetime.now().isoformat(),
            "income_statement": analyzer.get_income_statement(args.symbol, args.period),
            "balance_sheet": analyzer.get_balance_sheet(args.symbol, args.period),
            "cash_flow": analyzer.get_cash_flow(args.symbol, args.period),
            "ratios": analyzer.get_financial_ratios(args.symbol),
            "metrics": analyzer.get_key_metrics(args.symbol)
        }
        
        json_output = json.dumps(result, indent=2, default=str)
        
        if args.save:
            with open(args.save, 'w') as f:
                f.write(json_output)
            print(f"âœ… æ•°æ®å·²ä¿å­˜åˆ°: {args.save}")
        else:
            print(json_output)
    else:
        # æ ‡å‡†åˆ†ææ¨¡å¼
        analyzer.analyze_financial_health(args.symbol)
        
        if args.save:
            # åŒæ—¶ä¿å­˜JSON
            result = {
                "symbol": args.symbol,
                "timestamp": datetime.now().isoformat(),
                "income_statement": analyzer.get_income_statement(args.symbol, args.period),
                "balance_sheet": analyzer.get_balance_sheet(args.symbol, args.period),
                "cash_flow": analyzer.get_cash_flow(args.symbol, args.period),
                "ratios": analyzer.get_financial_ratios(args.symbol),
                "metrics": analyzer.get_key_metrics(args.symbol)
            }
            with open(args.save, 'w') as f:
                json.dump(result, f, indent=2, default=str)
            print(f"âœ… æ•°æ®å·²ä¿å­˜åˆ°: {args.save}")


if __name__ == "__main__":
    main()
