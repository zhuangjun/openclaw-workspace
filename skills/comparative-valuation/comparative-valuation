#!/usr/bin/env python3
"""
ç›¸å¯¹ä¼°å€¼å·¥å…· (Comparative Valuation)
æ¯”è¾ƒåŒè¡Œä¸šå…¬å¸çš„ä¼°å€¼å€æ•° (PE, PB, PS, EV/EBITDA)
"""

import argparse
import json
import sys
import os
from dataclasses import dataclass, asdict
from typing import Optional, List, Dict
from datetime import datetime

# æ·»åŠ  investment ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', '..', 'investment'))

@dataclass
class ValuationMetrics:
    """ä¼°å€¼æŒ‡æ ‡æ•°æ®ç±»"""
    symbol: str
    name: str = ""
    sector: str = ""
    
    # ä»·æ ¼æ•°æ®
    price: float = 0.0
    currency: str = "USD"
    market_cap: float = 0.0  # ç™¾ä¸‡ç¾å…ƒ
    
    # ä¼°å€¼å€æ•°
    pe_ttm: Optional[float] = None  # å¸‚ç›ˆç‡ TTM
    pe_forward: Optional[float] = None  # é¢„æµ‹å¸‚ç›ˆç‡
    pb: Optional[float] = None  # å¸‚å‡€ç‡
    ps: Optional[float] = None  # å¸‚é”€ç‡
    ev_ebitda: Optional[float] = None  # ä¼ä¸šä»·å€¼/EBITDA
    ev_revenue: Optional[float] = None  # ä¼ä¸šä»·å€¼/æ”¶å…¥
    
    # ç›ˆåˆ©èƒ½åŠ›
    eps_ttm: Optional[float] = None  # æ¯è‚¡æ”¶ç›Š TTM
    eps_growth: Optional[float] = None  # ç›ˆåˆ©å¢é•¿ç‡
    revenue_growth: Optional[float] = None  # æ”¶å…¥å¢é•¿
    roe: Optional[float] = None  # å‡€èµ„äº§æ”¶ç›Šç‡
    roa: Optional[float] = None  # èµ„äº§æ”¶ç›Šç‡
    
    # å…¶ä»–æŒ‡æ ‡
    dividend_yield: Optional[float] = None  # è‚¡æ¯ç‡
    beta: Optional[float] = None  # Beta
    
    def to_dict(self) -> Dict:
        return asdict(self)


class ValuationDataSource:
    """ä¼°å€¼æ•°æ®æºåŸºç±»"""
    
    def get_metrics(self, symbol: str) -> Optional[ValuationMetrics]:
        raise NotImplementedError


class YahooFinanceSource(ValuationDataSource):
    """Yahoo Finance æ•°æ®æº"""
    
    def __init__(self):
        self.yf = None
        try:
            import yfinance as yf
            self.yf = yf
        except ImportError:
            pass
    
    def get_metrics(self, symbol: str) -> Optional[ValuationMetrics]:
        if not self.yf:
            return None
        
        try:
            ticker = self.yf.Ticker(symbol)
            info = ticker.info
            
            if not info:
                return None
            
            metrics = ValuationMetrics(
                symbol=symbol,
                name=info.get('longName', info.get('shortName', '')),
                sector=info.get('sector', ''),
                price=info.get('currentPrice', info.get('regularMarketPrice', 0)),
                currency=info.get('currency', 'USD'),
                market_cap=info.get('marketCap', 0) / 1e6,  # è½¬æ¢ä¸ºç™¾ä¸‡
                
                pe_ttm=info.get('trailingPE'),
                pe_forward=info.get('forwardPE'),
                pb=info.get('priceToBook'),
                ps=info.get('priceToSalesTrailing12Months'),
                ev_ebitda=info.get('enterpriseToEbitda'),
                ev_revenue=info.get('enterpriseToRevenue'),
                
                eps_ttm=info.get('trailingEps'),
                eps_growth=info.get('earningsGrowth'),
                revenue_growth=info.get('revenueGrowth'),
                roe=info.get('returnOnEquity'),
                roa=info.get('returnOnAssets'),
                
                dividend_yield=info.get('dividendYield', 0) * 100 if info.get('dividendYield') else None,
                beta=info.get('beta')
            )
            return metrics
            
        except Exception as e:
            print(f"âš ï¸ Yahoo Finance è·å– {symbol} å¤±è´¥: {e}")
            return None


class DemoSource(ValuationDataSource):
    """æ¼”ç¤ºæ•°æ®æº - ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®"""
    
    # é¢„å®šä¹‰çš„æ¼”ç¤ºæ•°æ®
    DEMO_DATA = {
        'MSFT': {
            'name': 'Microsoft Corporation',
            'sector': 'Technology',
            'price': 415.82,
            'market_cap': 3089000,
            'pe_ttm': 34.5,
            'pe_forward': 28.2,
            'pb': 12.1,
            'ps': 12.8,
            'ev_ebitda': 24.5,
            'eps_ttm': 12.05,
            'eps_growth': 0.15,
            'revenue_growth': 0.12,
            'roe': 0.38,
            'dividend_yield': 0.7,
            'beta': 0.9
        },
        'AAPL': {
            'name': 'Apple Inc.',
            'sector': 'Technology',
            'price': 228.02,
            'market_cap': 3480000,
            'pe_ttm': 32.8,
            'pe_forward': 26.5,
            'pb': 48.5,
            'ps': 8.2,
            'ev_ebitda': 22.1,
            'eps_ttm': 6.95,
            'eps_growth': 0.08,
            'revenue_growth': 0.02,
            'roe': 1.60,
            'dividend_yield': 0.5,
            'beta': 1.2
        },
        'GOOGL': {
            'name': 'Alphabet Inc.',
            'sector': 'Technology',
            'price': 185.19,
            'market_cap': 2280000,
            'pe_ttm': 25.2,
            'pe_forward': 21.8,
            'pb': 6.8,
            'ps': 6.1,
            'ev_ebitda': 15.2,
            'eps_ttm': 7.35,
            'eps_growth': 0.25,
            'revenue_growth': 0.15,
            'roe': 0.31,
            'dividend_yield': 0.4,
            'beta': 1.05
        },
        'AMZN': {
            'name': 'Amazon.com Inc.',
            'sector': 'Consumer Cyclical',
            'price': 228.50,
            'market_cap': 2380000,
            'pe_ttm': 58.5,
            'pe_forward': 32.1,
            'pb': 8.2,
            'ps': 3.1,
            'ev_ebitda': 18.5,
            'eps_ttm': 3.91,
            'eps_growth': 0.35,
            'revenue_growth': 0.11,
            'roe': 0.16,
            'dividend_yield': None,
            'beta': 1.15
        },
        'NVDA': {
            'name': 'NVIDIA Corporation',
            'sector': 'Technology',
            'price': 138.25,
            'market_cap': 3380000,
            'pe_ttm': 65.8,
            'pe_forward': 35.2,
            'pb': 52.5,
            'ps': 28.5,
            'ev_ebitda': 55.2,
            'eps_ttm': 2.10,
            'eps_growth': 0.85,
            'revenue_growth': 0.94,
            'roe': 0.65,
            'dividend_yield': 0.03,
            'beta': 1.75
        },
        'META': {
            'name': 'Meta Platforms Inc.',
            'sector': 'Technology',
            'price': 736.65,
            'market_cap': 1880000,
            'pe_ttm': 26.8,
            'pe_forward': 22.5,
            'pb': 8.5,
            'ps': 9.8,
            'ev_ebitda': 16.5,
            'eps_ttm': 27.48,
            'eps_growth': 0.35,
            'revenue_growth': 0.20,
            'roe': 0.32,
            'dividend_yield': 0.4,
            'beta': 1.15
        },
        'TSLA': {
            'name': 'Tesla Inc.',
            'sector': 'Consumer Cyclical',
            'price': 355.84,
            'market_cap': 1140000,
            'pe_ttm': 172.5,
            'pe_forward': 85.2,
            'pb': 12.8,
            'ps': 8.5,
            'ev_ebitda': 52.5,
            'eps_ttm': 2.06,
            'eps_growth': 0.12,
            'revenue_growth': 0.08,
            'roe': 0.08,
            'dividend_yield': None,
            'beta': 2.05
        }
    }
    
    def get_metrics(self, symbol: str) -> Optional[ValuationMetrics]:
        data = self.DEMO_DATA.get(symbol.upper())
        if not data:
            return None
        
        return ValuationMetrics(
            symbol=symbol.upper(),
            name=data['name'],
            sector=data['sector'],
            price=data['price'],
            market_cap=data['market_cap'],
            pe_ttm=data['pe_ttm'],
            pe_forward=data['pe_forward'],
            pb=data['pb'],
            ps=data['ps'],
            ev_ebitda=data['ev_ebitda'],
            eps_ttm=data['eps_ttm'],
            eps_growth=data['eps_growth'],
            revenue_growth=data['revenue_growth'],
            roe=data['roe'],
            dividend_yield=data['dividend_yield'],
            beta=data['beta']
        )


class ComparativeValuation:
    """ç›¸å¯¹ä¼°å€¼åˆ†æå™¨"""
    
    def __init__(self, use_demo: bool = False):
        if use_demo:
            self.source = DemoSource()
        else:
            self.source = YahooFinanceSource()
            if not self.source.yf:
                print("âš ï¸ yfinance æœªå®‰è£…ï¼Œåˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼")
                self.source = DemoSource()
    
    def analyze(self, symbols: List[str]) -> List[ValuationMetrics]:
        """åˆ†æå¤šä¸ªè‚¡ç¥¨çš„ä¼°å€¼æŒ‡æ ‡"""
        results = []
        for symbol in symbols:
            metrics = self.source.get_metrics(symbol)
            if metrics:
                results.append(metrics)
        return results
    
    def compare(self, metrics_list: List[ValuationMetrics]) -> Dict:
        """æ¯”è¾ƒå¤šåªè‚¡ç¥¨çš„ä¼°å€¼æŒ‡æ ‡"""
        if not metrics_list:
            return {}
        
        comparison = {
            'symbols': [m.symbol for m in metrics_list],
            'timestamp': datetime.now().isoformat(),
            'averages': {},
            'rankings': {},
            'analysis': {}
        }
        
        # è®¡ç®—å„æŒ‡æ ‡çš„å¹³å‡å€¼
        indicators = ['pe_ttm', 'pe_forward', 'pb', 'ps', 'ev_ebitda', 'eps_growth', 'revenue_growth', 'roe']
        
        for indicator in indicators:
            values = [getattr(m, indicator) for m in metrics_list if getattr(m, indicator) is not None]
            if values:
                comparison['averages'][indicator] = {
                    'mean': sum(values) / len(values),
                    'median': sorted(values)[len(values) // 2],
                    'min': min(values),
                    'max': max(values)
                }
        
        # æ’åï¼ˆPE è¶Šä½è¶Šå¥½ï¼ŒGrowth è¶Šé«˜è¶Šå¥½ï¼‰
        pe_values = [(m.symbol, m.pe_ttm) for m in metrics_list if m.pe_ttm]
        pe_values.sort(key=lambda x: x[1])
        comparison['rankings']['pe_ttm'] = {s: i+1 for i, (s, _) in enumerate(pe_values)}
        
        growth_values = [(m.symbol, m.eps_growth) for m in metrics_list if m.eps_growth]
        growth_values.sort(key=lambda x: x[1], reverse=True)
        comparison['rankings']['eps_growth'] = {s: i+1 for i, (s, _) in enumerate(growth_values)}
        
        return comparison


def format_value(value: Optional[float], suffix: str = '', decimals: int = 2) -> str:
    """æ ¼å¼åŒ–æ•°å€¼è¾“å‡º"""
    if value is None:
        return 'N/A'
    if abs(value) >= 1000:
        return f'{value:,.0f}{suffix}'
    return f'{value:.{decimals}f}{suffix}'


def format_percent(value: Optional[float]) -> str:
    """æ ¼å¼åŒ–ç™¾åˆ†æ¯”"""
    if value is None:
        return 'N/A'
    return f'{value*100:.1f}%'


def print_text_report(metrics_list: List[ValuationMetrics], comparison: Dict):
    """æ‰“å°æ–‡æœ¬æ ¼å¼æŠ¥å‘Š"""
    print("=" * 90)
    print("ğŸ“Š ç›¸å¯¹ä¼°å€¼åˆ†ææŠ¥å‘Š")
    print("=" * 90)
    print(f"åˆ†ææ—¶é—´: {comparison.get('timestamp', datetime.now().isoformat())}")
    print()
    
    # ä¼°å€¼å€æ•°è¡¨æ ¼
    print("ã€ä¼°å€¼å€æ•°å¯¹æ¯”ã€‘")
    print("-" * 90)
    print(f"{'è‚¡ç¥¨':<8} {'ä»·æ ¼':>10} {'å¸‚å€¼(B)':>12} {'PE(TTM)':>10} {'PE(Fwd)':>10} {'PB':>8} {'PS':>8} {'EV/EBITDA':>10}")
    print("-" * 90)
    
    for m in metrics_list:
        market_cap_b = m.market_cap / 1000 if m.market_cap else 0
        print(f"{m.symbol:<8} {m.price:>10.2f} {market_cap_b:>11.1f}B {format_value(m.pe_ttm):>10} {format_value(m.pe_forward):>10} {format_value(m.pb):>8} {format_value(m.ps):>8} {format_value(m.ev_ebitda):>10}")
    
    # å¹³å‡å€¼
    if comparison.get('averages'):
        print("-" * 90)
        avg = comparison['averages']
        print(f"{'å¹³å‡å€¼':<8} {'':>10} {'':>12} {format_value(avg.get('pe_ttm', {}).get('mean')):>10} {format_value(avg.get('pe_forward', {}).get('mean')):>10} {format_value(avg.get('pb', {}).get('mean')):>8} {format_value(avg.get('ps', {}).get('mean')):>8} {format_value(avg.get('ev_ebitda', {}).get('mean')):>10}")
    print()
    
    # æˆé•¿æ€§æŒ‡æ ‡
    print("ã€æˆé•¿æ€§æŒ‡æ ‡ã€‘")
    print("-" * 70)
    print(f"{'è‚¡ç¥¨':<8} {'EPS(TTM)':>12} {'EPSå¢é•¿':>12} {'æ”¶å…¥å¢é•¿':>12} {'ROE':>10} {'è‚¡æ¯ç‡':>10}")
    print("-" * 70)
    
    for m in metrics_list:
        print(f"{m.symbol:<8} {format_value(m.eps_ttm):>12} {format_percent(m.eps_growth):>12} {format_percent(m.revenue_growth):>12} {format_percent(m.roe):>10} {format_value(m.dividend_yield, '%'):>10}")
    
    if comparison.get('averages'):
        print("-" * 70)
        avg = comparison['averages']
        print(f"{'å¹³å‡å€¼':<8} {'':>12} {format_percent(avg.get('eps_growth', {}).get('mean')):>12} {format_percent(avg.get('revenue_growth', {}).get('mean')):>12} {format_percent(avg.get('roe', {}).get('mean')):>10} {'':>10}")
    print()
    
    # ä¼°å€¼è§£è¯»
    print("ã€ä¼°å€¼è§£è¯»ã€‘")
    print("-" * 70)
    
    for m in metrics_list:
        interpretations = []
        
        # PE è¯„ä»·
        if m.pe_ttm:
            avg_pe = comparison.get('averages', {}).get('pe_ttm', {}).get('mean', m.pe_ttm)
            if m.pe_ttm < avg_pe * 0.8:
                interpretations.append(f"PEåä½({m.pe_ttm:.1f}x)")
            elif m.pe_ttm > avg_pe * 1.2:
                interpretations.append(f"PEåé«˜({m.pe_ttm:.1f}x)")
        
        # å¢é•¿è¯„ä»·
        if m.eps_growth:
            if m.eps_growth > 0.30:
                interpretations.append(f"é«˜å¢é•¿({m.eps_growth*100:.0f}%)")
            elif m.eps_growth < 0.05:
                interpretations.append(f"å¢é•¿ç¼“æ…¢({m.eps_growth*100:.0f}%)")
        
        # PEG è¯„ä»·
        if m.pe_ttm and m.eps_growth and m.eps_growth > 0:
            peg = m.pe_ttm / (m.eps_growth * 100)
            if peg < 1:
                interpretations.append(f"PEG<1(ä½ä¼°)")
            elif peg > 2:
                interpretations.append(f"PEG>2(é«˜ä¼°)")
        
        interp_str = " | ".join(interpretations) if interpretations else "æ­£å¸¸åŒºé—´"
        print(f"{m.symbol:<8} {interp_str}")
    
    print()
    print("=" * 90)


def main():
    parser = argparse.ArgumentParser(description='ç›¸å¯¹ä¼°å€¼åˆ†æå·¥å…·')
    parser.add_argument('--symbols', '-s', required=True, help='è‚¡ç¥¨ä»£ç ï¼Œé€—å·åˆ†éš” (å¦‚: MSFT,AAPL,GOOGL)')
    parser.add_argument('--demo', action='store_true', help='ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼')
    parser.add_argument('--output', '-o', choices=['text', 'json'], default='text', help='è¾“å‡ºæ ¼å¼')
    parser.add_argument('--save', help='ä¿å­˜ç»“æœåˆ°æ–‡ä»¶')
    
    args = parser.parse_args()
    
    # è§£æè‚¡ç¥¨ä»£ç 
    symbols = [s.strip().upper() for s in args.symbols.split(',')]
    
    # åˆ›å»ºåˆ†æå™¨
    analyzer = ComparativeValuation(use_demo=args.demo)
    
    # è·å–æ•°æ®
    print(f"æ­£åœ¨è·å– {len(symbols)} åªè‚¡ç¥¨çš„ä¼°å€¼æ•°æ®...")
    metrics_list = analyzer.analyze(symbols)
    
    if not metrics_list:
        print("âŒ æœªèƒ½è·å–ä»»ä½•è‚¡ç¥¨æ•°æ®")
        sys.exit(1)
    
    print(f"âœ… æˆåŠŸè·å– {len(metrics_list)} åªè‚¡ç¥¨æ•°æ®")
    
    # å¯¹æ¯”åˆ†æ
    comparison = analyzer.compare(metrics_list)
    
    # è¾“å‡ºç»“æœ
    if args.output == 'json':
        result = {
            'metrics': [m.to_dict() for m in metrics_list],
            'comparison': comparison
        }
        output = json.dumps(result, indent=2, ensure_ascii=False)
        print(output)
        
        if args.save:
            with open(args.save, 'w', encoding='utf-8') as f:
                f.write(output)
            print(f"\nğŸ’¾ ç»“æœå·²ä¿å­˜åˆ°: {args.save}")
    else:
        print_text_report(metrics_list, comparison)
        
        if args.save:
            result = {
                'metrics': [m.to_dict() for m in metrics_list],
                'comparison': comparison
            }
            with open(args.save, 'w', encoding='utf-8') as f:
                json.dump(result, f, indent=2, ensure_ascii=False)
            print(f"ğŸ’¾ ç»“æœå·²ä¿å­˜åˆ°: {args.save}")


if __name__ == '__main__':
    main()
