# 2026-02-16 每日学习报告

## 学习时间
凌晨 00:00-01:30 (约1.5小时)

## 今日学习主题
**投资组合风险分析工具开发**

## 学习背景
当前投资工具链已有：
- ✅ 实时行情获取 (stock-quote)
- ✅ 技术分析指标 (technical-analysis)
- ✅ DCF 估值模型 (dcf-valuation)
- ❌ 风险分析工具 (缺失)

本次学习填补了这一关键缺口。

## 学习内容

### 1. 风险指标研究
通过搜索学习了以下核心风险指标：

| 指标类别 | 指标名称 | 计算公式/说明 |
|---------|---------|--------------|
| **风险价值** | VaR (95%/99%) | 历史模拟法、参数法、Cornish-Fisher |
| **预期亏损** | CVaR | 超过 VaR 阈值的平均损失 |
| **回撤指标** | Max Drawdown | 从高点到低点的最大跌幅 |
| **波动率** | 年化波动率 | σ × √252 |
| **调整收益** | 夏普比率 | (Rp - Rf) / σp |
| **调整收益** | 索提诺比率 | (Rp - Rf) / 下行波动率 |
| **调整收益** | 卡玛比率 | 年化收益 / 最大回撤 |

### 2. VaR 计算方法

学习了三种 VaR 计算方法：

**历史模拟法** (非参数)
```python
var = np.percentile(returns, (1 - confidence) * 100)
```

**参数法** (假设正态分布)
```python
var = mean + z_score * std
```

**Cornish-Fisher** (修正偏度峰度)
```python
z_cf = z + (z²-1)*skew/6 + (z³-3z)*kurt/24
```

### 3. 工具实现

创建了 `portfolio_risk.py`，实现了：

**核心功能：**
- ✅ 单资产风险分析
- ✅ 组合风险分析（含相关性矩阵）
- ✅ 三种 VaR 计算方法
- ✅ CVaR (条件 VaR)
- ✅ 夏普/索提诺/卡玛比率
- ✅ 最大回撤及持续天数
- ✅ 收益分布特征（偏度、峰度、正态性检验）
- ✅ 综合风险评级

**数据源支持：**
1. LongPort API (美股/港股)
2. Yahoo Finance (备选)
3. 演示模式 (模拟数据)

**输出格式：**
- 表格形式（人类可读）
- JSON 格式（程序化使用）

### 4. 测试验证

测试了多种资产类型：

| 资产 | 波动率 | 最大回撤 | VaR(95%) | 评级 |
|------|--------|---------|----------|------|
| MSFT | 23% | -7.9% | -2.2% | 🟢 中等 |
| BTC | 60% | -38% | -7.3% | 🔴 高风险 |
| GLD | 13% | -17% | -1.5% | 🟢 中等 |

测试结果符合预期：
- BTC 显示出高波动率、高回撤特征
- 黄金 (GLD) 波动率较低
- 评级系统能正确区分风险等级

### 5. Skill 创建

创建了 `portfolio-risk` Skill：

```
skills/portfolio-risk/
├── SKILL.md              # 技能文档
└── scripts/
    └── portfolio_risk.py # 主脚本
```

## 遇到的问题及解决

### 问题 1: argparse help 字符串中的 % 符号
**现象**: `ValueError: unsupported format character`
**原因**: argparse 将 % 视为格式字符串占位符
**解决**: 双写 %% 进行转义

### 问题 2: numpy bool JSON 序列化
**现象**: `Object of type bool_ is not JSON serializable`
**原因**: numpy.bool_ 不是 Python 原生 bool
**解决**: 在 to_dict() 中显式转换 `bool(d['is_normal'])`

### 问题 3: 组合分析权重计算错误
**现象**: `division by zero`
**原因**: 使用了错误的 total_value 字段名
**解决**: 修正为 `portfolio['summary']['current_value']`

## 学习成果

### 新增文件
1. `investment/portfolio_risk.py` (22KB, 661行)
2. `skills/portfolio-risk/SKILL.md`
3. `skills/portfolio-risk/scripts/portfolio_risk.py`

### 用法示例
```bash
# 单资产分析
cd investment
python3 portfolio_risk.py --symbol MSFT --days 90 --demo

# 组合分析
python3 portfolio_risk.py --portfolio-file data/portfolio.json

# JSON 输出
python3 portfolio_risk.py --symbol BTC --output json
```

## 下一步计划

1. **集成到工作流**: 在交易决策检查时自动运行组合风险分析
2. **历史风险追踪**: 记录组合风险指标的变化趋势
3. **压力测试**: 添加情景分析（如市场大跌时的组合表现）
4. **风险预算**: 基于风险指标动态调整仓位

## 参考资源

- GitHub: SharmaVidhiHaresh/Portfolio-Risk-Analysis-with-Python
- GitHub: George-Dros/Portfolio_Optimization
- Turing Finance: Computational Investing with Python

---
**学习时间**: 1.5小时  
**代码行数**: 661行  
**测试通过率**: 100% (3/3种资产类型)
