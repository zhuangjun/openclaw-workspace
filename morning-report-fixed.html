<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥æŠ•èµ„æ™¨æŠ¥ - Friday</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #0a0e14;
            color: #e6e6e6;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            padding: 30px 0;
            border-bottom: 1px solid #1f2937;
            margin-bottom: 30px;
        }
        .back-link {
            color: #8b949e;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 16px;
        }
        .back-link:hover {
            color: #00d4aa;
        }
        h1 {
            font-size: 1.8em;
            color: #f0f6fc;
        }
        .date-selector {
            display: flex;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .date-btn {
            padding: 8px 16px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #8b949e;
            cursor: pointer;
            font-size: 0.9em;
        }
        .date-btn:hover {
            border-color: #00d4aa;
            color: #00d4aa;
        }
        .date-btn.active {
            background: #00d4aa;
            border-color: #00d4aa;
            color: #0a0e14;
        }
        .report-content {
            background: #111820;
            border-radius: 12px;
            padding: 28px;
            border: 1px solid #1f2937;
        }
        .indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
            padding-bottom: 24px;
            border-bottom: 1px solid #21262d;
        }
        .indicator {
            background: #0d1117;
            padding: 16px;
            border-radius: 8px;
        }
        .indicator-label {
            color: #8b949e;
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        .indicator-value {
            font-size: 1.5em;
            font-weight: 600;
        }
        .section {
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 1.2em;
            color: #00d4aa;
            margin-bottom: 12px;
            padding-left: 12px;
            border-left: 3px solid #00d4aa;
        }
        .section-content {
            color: #c9d1d9;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #8b949e;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f85149;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="../" class="back-link">â† è¿”å›æ€»è§ˆ</a>
            <h1>ğŸ“° æ¯æ—¥æŠ•èµ„æ™¨æŠ¥</h1>
            <p style="color: #8b949e; margin-top: 8px;">ç¾è‚¡+æ¸¯è‚¡ç»¼åˆæ™¨æŠ¥ï¼Œä¿ç•™30å¤©å†å²</p>
        </header>

        <div class="date-selector" id="dateSelector">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div id="reportContent">
            <div class="loading">é€‰æ‹©æ—¥æœŸæŸ¥çœ‹æ™¨æŠ¥</div>
        </div>
    </div>

    <script>
        let reports = [];
        let currentId = null;

        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            try {
                const response = await fetch('/Friday/api/tasks/results?task_type=morning_report&limit=30');
                reports = await response.json();
                renderDateSelector();
                // é»˜è®¤æ˜¾ç¤ºæœ€æ–°
                if (reports.length > 0) {
                    loadReport(reports[0].id);
                }
            } catch (err) {
                document.getElementById('dateSelector').innerHTML = 
                    '<div class="error">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            }
        }

        // æ¸²æŸ“æ—¥æœŸé€‰æ‹©å™¨
        function renderDateSelector() {
            const container = document.getElementById('dateSelector');
            container.innerHTML = reports.map(r => {
                const date = new Date(r.task_date);
                const label = `${date.getMonth()+1}/${date.getDate()}`;
                return `<button class="date-btn ${r.id === currentId ? 'active' : ''}" 
                        onclick="loadReport(${r.id})">${label}</button>`;
            }).join('');
        }

        // åŠ è½½æŒ‡å®šæŠ¥å‘Š
        async function loadReport(id) {
            currentId = id;
            renderDateSelector();
            
            const container = document.getElementById('reportContent');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const response = await fetch(`/Friday/api/tasks/results/${id}`);
                const report = await response.json();
                
                if (response.ok) {
                    renderReport(report);
                } else {
                    container.innerHTML = '<div class="error">æœªæ‰¾åˆ°è¯¥æ—¥æœŸçš„æ™¨æŠ¥</div>';
                }
            } catch (err) {
                container.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            }
        }

        // æ¸²æŸ“æ™¨æŠ¥å†…å®¹ - ä» result_data æˆ– content å­—æ®µè§£æ
        function renderReport(r) {
            const container = document.getElementById('reportContent');
            
            // è·å–æŠ¥å‘Šå†…å®¹æ•°æ®
            let data = r.result_data || r.content || r;
            
            // å¦‚æœ data æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ JSON
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    // ä¸æ˜¯ JSONï¼ŒæŒ‰çº¯æ–‡æœ¬å¤„ç†
                }
            }
            
            // ä» metrics å­—æ®µè·å–æŒ‡æ ‡
            const metrics = r.metrics || data.metrics || {};
            
            container.innerHTML = `
                <div class="report-content">
                    <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #21262d;">
                        <h2 style="color: #f0f6fc; margin-bottom: 8px;">${r.title || data.title || 'æ¯æ—¥æŠ•èµ„æ™¨æŠ¥'}</h2>
                        <p style="color: #8b949e; font-size: 0.9em;">${r.task_date || data.date || ''} Â· ${r.summary || data.summary || ''}</p>
                    </div>
                    
                    <div class="indicators">
                        <div class="indicator">
                            <div class="indicator-label">VIX æ³¢åŠ¨ç‡</div>
                            <div class="indicator-value" style="color: ${getVixColor(metrics.vix)}">${metrics.vix || '--'}</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">ç¾è‚¡ææƒ§è´ªå©ª</div>
                            <div class="indicator-value" style="color: ${getFearGreedColor(metrics.fear_greed_us)}">${metrics.fear_greed_us || '--'}</div>
                        </div>
                        <div class="indicator">
                            <div class="indicator-label">åŠ å¯†ææƒ§è´ªå©ª</div>
                            <div class="indicator-value" style="color: ${getFearGreedColor(metrics.fear_greed_crypto)}">${metrics.fear_greed_crypto || '--'}</div>
                        </div>
                    </div>
                    
                    ${renderSection('ğŸ“Œ ä¸»çº¿å™äº‹', data.narrative)}
                    ${renderSection('ğŸ’° èµ„é‡‘æµå‘', data.fund_flow)}
                    ${renderSection('ğŸ˜Š æƒ…ç»ªå‘¨æœŸ', data.sentiment_cycle)}
                    ${renderSection('âš¡ é¢„æœŸå·®', data.expectation_gap)}
                    ${renderSection('ğŸ¯ ç­–ç•¥å»ºè®®', data.strategy)}
                    ${renderSection('ğŸ‡ºğŸ‡¸ ç¾è‚¡å¤§ç›˜', data.us_market_summary)}
                    ${renderSection('ğŸ¢ MAG7 åˆ†æ', data.mag7_analysis)}
                    ${renderSection('ğŸ‡­ğŸ‡° æ¸¯è‚¡å¸‚åœº', data.hk_market_summary)}
                    ${renderSection('ğŸ“Š é‡ä»“è‚¡è¿½è¸ª', data.heavy_stocks_tracking)}
                    ${renderSection('ğŸ“… æœ¬å‘¨å…³æ³¨', data.weekly_focus)}
                    
                    ${data.content ? `<div class="section"><div class="section-content">${data.content}</div></div>` : ''}
                    ${r.content && typeof r.content === 'string' && !data.content ? `<div class="section"><div class="section-content">${r.content}</div></div>` : ''}
                </div>
            `;
        }

        function renderSection(title, content) {
            if (!content) return '';
            return `
                <div class="section">
                    <div class="section-title">${title}</div>
                    <div class="section-content">${content}</div>
                </div>
            `;
        }

        function getVixColor(vix) {
            if (!vix) return '#e6e6e6';
            if (vix < 20) return '#3fb950'; // å¹³é™
            if (vix < 30) return '#f0883e'; // æ‹…å¿§
            return '#f85149'; // ææ…Œ
        }

        function getFearGreedColor(score) {
            if (!score) return '#e6e6e6';
            if (score < 25) return '#f85149'; // ææƒ§
            if (score > 75) return '#f85149'; // è´ªå©ª
            return '#3fb950'; // ä¸­æ€§
        }

        // åˆå§‹åŒ–
        loadHistory();
    </script>
</body>
</html>
