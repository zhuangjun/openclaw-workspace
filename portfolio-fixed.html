<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ‹ŸæŠ•èµ„ç»„åˆ - Friday</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #0a0e14;
            color: #e6e6e6;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            padding: 30px 0;
            border-bottom: 1px solid #1f2937;
            margin-bottom: 30px;
        }
        .back-link {
            color: #8b949e;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 16px;
        }
        .back-link:hover {
            color: #00d4aa;
        }
        h1 {
            font-size: 1.8em;
            color: #f0f6fc;
        }
        .subtitle {
            color: #8b949e;
            margin-top: 8px;
        }
        
        /* ç»„åˆæ¦‚è§ˆ */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .overview-card {
            background: #111820;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #1f2937;
        }
        .overview-label {
            color: #8b949e;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .overview-value {
            font-size: 2em;
            font-weight: 700;
        }
        .positive { color: #3fb950; }
        .negative { color: #f85149; }
        .neutral { color: #e6e6e6; }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .chart-section {
            background: #111820;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #1f2937;
            margin-bottom: 30px;
        }
        .chart-title {
            font-size: 1.1em;
            color: #f0f6fc;
            margin-bottom: 20px;
        }
        #valueChart {
            width: 100%;
            height: 300px;
        }
        
        /* æŒä»“è¡¨æ ¼ */
        .holdings-section {
            background: #111820;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #1f2937;
            margin-bottom: 30px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.1em;
            color: #f0f6fc;
        }
        .holdings-table {
            width: 100%;
            border-collapse: collapse;
        }
        .holdings-table th {
            text-align: left;
            padding: 12px;
            color: #8b949e;
            font-weight: 500;
            border-bottom: 1px solid #21262d;
            font-size: 0.9em;
        }
        .holdings-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #21262d;
        }
        .holdings-table tr:hover {
            background: #161b22;
        }
        .stock-name {
            font-weight: 500;
            color: #f0f6fc;
        }
        .stock-code {
            color: #6e7681;
            font-size: 0.85em;
        }
        
        /* èµ„äº§é…ç½®é¥¼å›¾ */
        .allocation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        @media (max-width: 768px) {
            .allocation-grid {
                grid-template-columns: 1fr;
            }
        }
        .allocation-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        .legend-label {
            flex: 1;
            color: #c9d1d9;
        }
        .legend-value {
            color: #8b949e;
            font-size: 0.9em;
        }
        
        /* äº¤æ˜“è®°å½• */
        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #21262d;
        }
        .trade-item:last-child {
            border-bottom: none;
        }
        .trade-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .trade-type {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .buy { background: rgba(63, 185, 80, 0.2); color: #3fb950; }
        .sell { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .trade-date {
            color: #6e7681;
            font-size: 0.85em;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #8b949e;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f85149;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="../" class="back-link">â† è¿”å›æ€»è§ˆ</a>
            <h1>ğŸ“ˆ æ¨¡æ‹ŸæŠ•èµ„ç»„åˆ</h1>
            <p class="subtitle">å¤§ä»“ç¨³å¥ï¼Œå°ä»“çˆ†å‘ï¼Œæ”»å®ˆå…¼å¤‡çš„èµ„äº§é…ç½®è¿½è¸ª</p>
        </header>

        <!-- ç»„åˆæ¦‚è§ˆ -->
        <div class="overview-grid" id="overview">
            <div class="overview-card">
                <div class="overview-label">å½“å‰å‡€å€¼</div>
                <div class="overview-value neutral" id="totalValue">--</div>
            </div>
            <div class="overview-card">
                <div class="overview-label">ç´¯è®¡æ”¶ç›Š</div>
                <div class="overview-value" id="totalReturn">--</div>
            </div>
            <div class="overview-card">
                <div class="overview-label">ç°é‡‘å æ¯”</div>
                <div class="overview-value neutral" id="cashRatio">--</div>
            </div>
            <div class="overview-card">
                <div class="overview-label">æŒä»“æ•°é‡</div>
                <div class="overview-value neutral" id="holdingCount">--</div>
            </div>
        </div>

        <!-- å‡€å€¼æ›²çº¿ -->
        <div class="chart-section">
            <div class="chart-title">å‡€å€¼èµ°åŠ¿</div>
            <div id="valueChart">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- èµ„äº§é…ç½® -->
        <div class="chart-section">
            <div class="section-header">
                <div class="chart-title">èµ„äº§é…ç½®</div>
            </div>
            <div class="allocation-grid" id="allocationSection">
                <div id="allocationChart" style="height: 200px;">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <div class="allocation-legend" id="allocationLegend"></div>
            </div>
        </div>

        <!-- æŒä»“æ˜ç»† -->
        <div class="holdings-section">
            <div class="section-header">
                <div class="section-title">æŒä»“æ˜ç»†</div>
            </div>
            <table class="holdings-table" id="holdingsTable">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨</th>
                        <th>ä»“ä½</th>
                        <th>æˆæœ¬ä»·</th>
                        <th>ç°ä»·</th>
                        <th>ç›ˆäº</th>
                    </tr>
                </thead>
                <tbody id="holdingsBody">
                    <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- æœ€è¿‘äº¤æ˜“ -->
        <div class="holdings-section">
            <div class="section-header">
                <div class="section-title">æœ€è¿‘äº¤æ˜“</div>
            </div>
            <div id="tradesList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // åŠ è½½ç»„åˆæ•°æ®
        async function loadPortfolio() {
            try {
                const response = await fetch('/Friday/api/portfolio/summary');
                const data = await response.json();
                
                // æ›´æ–°æ¦‚è§ˆ
                document.getElementById('totalValue').textContent = formatValue(data.value);
                const returnEl = document.getElementById('totalReturn');
                returnEl.textContent = (data.return_pct >= 0 ? '+' : '') + data.return_pct.toFixed(2) + '%';
                returnEl.className = 'overview-value ' + (data.return_pct >= 0 ? 'positive' : 'negative');
                
                // è®¡ç®—ç°é‡‘å æ¯”å’ŒæŒä»“æ•°é‡
                const holdings = data.holdings || [];
                const totalHoldingValue = holdings.reduce((sum, h) => sum + (h.value || 0), 0);
                const cashValue = data.value - totalHoldingValue;
                const cashRatio = data.value > 0 ? (cashValue / data.value * 100) : 0;
                
                document.getElementById('cashRatio').textContent = cashRatio.toFixed(1) + '%';
                document.getElementById('holdingCount').textContent = holdings.length + ' åª';
                
                // æ¸²æŸ“æŒä»“
                renderHoldings(holdings);
                
                // æ¸²æŸ“èµ„äº§é…ç½®
                renderAllocation(data.allocation || []);
                
                // æ¸²æŸ“å‡€å€¼æ›²çº¿ (ç®€åŒ–ç‰ˆï¼Œä½¿ç”¨ Canvas ç»˜åˆ¶)
                renderValueChart(data.history || []);
                
            } catch (err) {
                document.getElementById('overview').innerHTML = 
                    '<div class="error">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            }
        }
        
        // æ¸²æŸ“æŒä»“è¡¨æ ¼
        function renderHoldings(holdings) {
            const tbody = document.getElementById('holdingsBody');
            if (holdings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6e7681;">æš‚æ— æŒä»“</td></tr>';
                return;
            }
            
            tbody.innerHTML = holdings.map(h => {
                const pnl = h.pnl_pct || ((h.current_price - h.cost_price) / h.cost_price * 100);
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                const pnlSign = pnl >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td>
                            <div class="stock-name">${h.name || h.symbol}</div>
                            <div class="stock-code">${h.symbol} Â· ${h.market || ''}</div>
                        </td>
                        <td>${h.weight?.toFixed(1) || '--'}%</td>
                        <td>Â¥${h.cost_price?.toFixed(2) || '--'}</td>
                        <td>Â¥${h.current_price?.toFixed(2) || '--'}</td>
                        <td class="${pnlClass}">${pnlSign}${pnl.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“èµ„äº§é…ç½®
        function renderAllocation(allocation) {
            const colors = ['#00d4aa', '#00a8e8', '#f0883e', '#a371f7', '#f85149', '#3fb950'];
            
            if (allocation.length === 0) {
                document.getElementById('allocationSection').innerHTML = 
                    '<div style="text-align:center;color:#6e7681;padding:40px;">æš‚æ— é…ç½®æ•°æ®</div>';
                return;
            }
            
            // æ¸²æŸ“å›¾ä¾‹
            document.getElementById('allocationLegend').innerHTML = allocation.map((item, i) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colors[i % colors.length]}"></div>
                    <div class="legend-label">${item.name}</div>
                    <div class="legend-value">${item.percent?.toFixed(1) || item.weight?.toFixed(1) || '--'}%</div>
                </div>
            `).join('');
            
            // ç»˜åˆ¶ç®€å•çš„æ¡å½¢å›¾ä½œä¸ºé¥¼å›¾æ›¿ä»£
            const chartEl = document.getElementById('allocationChart');
            chartEl.innerHTML = `
                <div style="display:flex;flex-direction:column;gap:10px;height:100%;justify-content:center;">
                    ${allocation.map((item, i) => `
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="flex:1;background:#161b22;border-radius:4px;height:24px;overflow:hidden;">
                                <div style="width:${item.percent || item.weight || 0}%;height:100%;background:${colors[i % colors.length]};border-radius:4px;"></div>
                            </div>
                            <div style="width:50px;text-align:right;color:#8b949e;font-size:0.85em;">${item.percent?.toFixed(1) || item.weight?.toFixed(1) || 0}%</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // æ¸²æŸ“å‡€å€¼æ›²çº¿
        function renderValueChart(history) {
            const chartEl = document.getElementById('valueChart');
            
            if (!history || history.length === 0) {
                chartEl.innerHTML = '<div style="text-align:center;color:#6e7681;padding:40px;">æš‚æ— å†å²æ•°æ®</div>';
                return;
            }
            
            // ä½¿ç”¨ Canvas ç»˜åˆ¶ç®€å•çš„æŠ˜çº¿å›¾
            const canvas = document.createElement('canvas');
            canvas.width = chartEl.clientWidth || 800;
            canvas.height = 300;
            chartEl.innerHTML = '';
            chartEl.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            const padding = 40;
            const chartW = canvas.width - padding * 2;
            const chartH = canvas.height - padding * 2;
            
            // æ‰¾å‡ºæœ€å°æœ€å¤§å€¼
            const values = history.map(h => h.value);
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#21262d';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + chartH * i / 4;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartW, y);
                ctx.stroke();
                
                // Yè½´æ ‡ç­¾
                const val = maxVal - range * i / 4;
                ctx.fillStyle = '#6e7681';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText((val / 10000).toFixed(1) + 'ä¸‡', padding - 10, y + 4);
            }
            
            // ç»˜åˆ¶æŠ˜çº¿
            ctx.strokeStyle = '#00d4aa';
            ctx.lineWidth = 2;
            ctx.beginPath();
            history.forEach((h, i) => {
                const x = padding + chartW * i / (history.length - 1);
                const y = padding + chartH * (1 - (h.value - minVal) / range);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // ç»˜åˆ¶å¡«å……åŒºåŸŸ
            ctx.fillStyle = 'rgba(0, 212, 170, 0.1)';
            ctx.beginPath();
            history.forEach((h, i) => {
                const x = padding + chartW * i / (history.length - 1);
                const y = padding + chartH * (1 - (h.value - minVal) / range);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.lineTo(padding + chartW, padding + chartH);
            ctx.lineTo(padding, padding + chartH);
            ctx.closePath();
            ctx.fill();
            
            // ç»˜åˆ¶ç‚¹
            ctx.fillStyle = '#00d4aa';
            history.forEach((h, i) => {
                const x = padding + chartW * i / (history.length - 1);
                const y = padding + chartH * (1 - (h.value - minVal) / range);
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Xè½´æ ‡ç­¾ (é¦–å°¾æ—¥æœŸ)
            ctx.fillStyle = '#6e7681';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(history[0].date, padding, canvas.height - 10);
            ctx.fillText(history[history.length - 1].date, padding + chartW, canvas.height - 10);
        }
        
        // æ ¼å¼åŒ–æ•°å€¼
        function formatValue(val) {
            if (val >= 100000000) return 'Â¥' + (val / 100000000).toFixed(2) + 'äº¿';
            if (val >= 10000) return 'Â¥' + (val / 10000).toFixed(1) + 'ä¸‡';
            return 'Â¥' + val.toFixed(0);
        }
        
        // åŠ è½½äº¤æ˜“è®°å½•
        async function loadTrades() {
            try {
                const response = await fetch('/Friday/api/portfolio/trades?limit=10');
                const trades = await response.json();
                
                const container = document.getElementById('tradesList');
                if (trades.length === 0) {
                    container.innerHTML = '<div style="text-align:center;color:#6e7681;padding:20px;">æš‚æ— äº¤æ˜“è®°å½•</div>';
                    return;
                }
                
                container.innerHTML = trades.map(t => `
                    <div class="trade-item">
                        <div class="trade-info">
                            <span class="trade-type ${t.type === 'buy' ? 'buy' : 'sell'}">${t.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}</span>
                            <div>
                                <div style="color:#f0f6fc;">${t.stock_name || t.symbol}</div>
                                <div class="trade-date">${t.trade_date}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:#f0f6fc;">${t.shares}è‚¡ @ Â¥${t.price?.toFixed(2)}</div>
                            <div style="color:#8b949e;font-size:0.9em;">Â¥${(t.shares * t.price)?.toFixed(0)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('tradesList').innerHTML = 
                    '<div class="error">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            }
        }
        
        // åˆå§‹åŒ–
        loadPortfolio();
        loadTrades();
    </script>
</body>
</html>
